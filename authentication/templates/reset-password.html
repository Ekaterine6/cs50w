<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/static/styles.css">
  <title>Verification</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    form {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      max-width: 400px;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h2>პაროლის განახლება SMS ვერიფიკაციით</h2>
  <a class="home_button" href="/index.html">მთავარი</a>

  <!-- Form to request the verification code -->
  <form id="startVerificationForm">
    <h3>ვერიფიკაციის კოდის მოთხოვნა</h3>
    <label for="email">Email:</label>
    <input 
      type="email" 
      id="email" 
      name="email" 
      placeholder="შეიყვანეთ Email" 
      required 
    />

    <label for="phone">ტელეფონი (+995XXXXXXXX):</label>
    <input 
      type="text" 
      id="phone" 
      name="phone"
      placeholder="+995XXXXXXXX" 
      required 
    />

    <button type="submit">ვერიფიკაციის კოდის მიღება</button>
  </form>

  <!-- Form to verify the code and reset the password -->
  <form id="checkVerificationForm" class="hidden">
    <h3>დაადასტურე კოდი და გაანახლე პაროლი</h3>
    <label for="code">ვერიფიკაციის კოდი:</label>
    <input 
      type="text" 
      id="code" 
      name="code" 
      placeholder="000000" 
      required 
    />

    <label for="newPassword">ახალი პაროლი:</label>
    <input 
      type="password" 
      id="newPassword" 
      name="newPassword" 
      placeholder="Abcd123!" 
      required 
    />

    <button type="submit">პაროლის განახლება</button>
  </form>

  <script>
    // Handle the start verification form submission
    document.getElementById("startVerificationForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = new URLSearchParams(formData);
      
      fetch("/start-verification", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: data
      })
      .then(response => {
        if (!response.ok) return response.text().then(text => { throw new Error(text) });
        return response.json();
      })
      .then(result => {
        alert(result.message);
        console.log("Verification status returned:", result.status);
        // Regardless of the status value, show the verification/reset form.
        document.getElementById("startVerificationForm").classList.add("hidden");
        document.getElementById("checkVerificationForm").classList.remove("hidden");
      })
      .catch(error => {
        console.error("Error starting verification:", error);
        alert("Error: " + error.message);
      });
    });

    // Handle the check verification form submission
    document.getElementById("checkVerificationForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = new URLSearchParams(formData);
      
      fetch("/check-verification", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: data
      })
      .then(response => {
        if (!response.ok) return response.text().then(text => { throw new Error(text) });
        return response.text();
      })
      .then(result => {
        alert(result);
        // Optionally, you can redirect or refresh after a successful password reset.
      })
      .catch(error => {
        console.error("Error verifying code:", error);
        alert("Error: " + error.message);
      });
    });
  </script>
</body>
</html>
